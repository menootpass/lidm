<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cara Praktis Membersihkan Noda: Belajar Sains Sederhana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('bg-ingame.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .game-container {
            max-width: 420px;
            height: 100vh;
            max-height: 800px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .page {
            display: none;
        }
        .page.active {
            display: flex;
        }
        .btn {
            transition: all 0.2s ease-in-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .option-btn {
            border: 2px solid rgba(217, 226, 236, 0.8);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        .option-btn:hover {
            border-color: #60A5FA; /* Blue accent */
            background-color: rgba(239, 246, 255, 0.9);
        }
        .option-btn.selected {
            border-color: #34D399; /* Green accent */
            background-color: rgba(240, 253, 244, 0.9);
        }
        .bubble {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 16px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.9);
            border-bottom: 0;
            margin-left: -15px;
            margin-bottom: -15px;
        }
        .result-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .experiment-area {
            background: rgba(248, 250, 252, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            min-height: 200px;
        }
        .draggable-ingredient {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            user-select: none;
        }
        .draggable-ingredient:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        .draggable-ingredient.dragging {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .drop-zone-active {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        .drop-zone-highlight {
            border-color: #3B82F6 !important;
            background-color: rgba(59, 130, 246, 0.2) !important;
            animation: pulse 1s infinite;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        .stain-animation {
            transition: opacity 1.5s ease-out;
        }
        .stain-hidden {
            opacity: 0;
        }
        .ingredient-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .ingredient-card:hover, .ingredient-card.selected {
             transform: scale(1.05);
             border-color: #60A5FA;
        }
        .action-icon {
             transition: transform 0.2s ease;
        }
        .action-icon:hover {
            transform: scale(1.1);
        }
        
        .action-icon:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        
        .action-icon.washing {
            animation: action-pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes action-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Washing Animation Styles */
        .bubble-animation {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(59, 130, 246, 0.6);
            border-radius: 50%;
            animation: bubble-rise 2s ease-in-out infinite;
        }
        
        @keyframes bubble-rise {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-20px) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-40px) scale(0.3);
                opacity: 0;
            }
        }
        
        .fabric-wash {
            animation: fabric-shake 0.5s ease-in-out infinite;
        }
        
        @keyframes fabric-shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-2px) rotate(-1deg); }
            75% { transform: translateX(2px) rotate(1deg); }
        }
        
        .water-ripple {
            animation: water-ripple 1s ease-in-out infinite;
        }
        
        @keyframes water-ripple {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .stain-fade {
            animation: stain-fade 1s ease-out forwards;
        }
        
        @keyframes stain-fade {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0.3; transform: scale(0.8); }
        }
        
        .splash-effect {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(59, 130, 246, 0.8);
            border-radius: 50%;
            animation: splash 0.6s ease-out forwards;
        }
        
        @keyframes splash {
            0% {
                transform: scale(0) translateY(0);
                opacity: 1;
            }
            100% {
                transform: scale(1.5) translateY(-10px);
                opacity: 0;
            }
        }
        
        .result-success {
            animation: success-bounce 0.6s ease-out;
        }
        
        @keyframes success-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .result-fail {
            animation: fail-shake 0.5s ease-in-out;
        }
        
        @keyframes fail-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Interactive Washing Styles */
        .washing-area {
            position: relative;
            cursor: grab;
            user-select: none;
        }
        
        .washing-area:active {
            cursor: grabbing;
        }
        
        .scrub-cursor {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2"><path d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>'), auto;
        }
        
        .brush-cursor {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2"><path d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>'), auto;
        }
        
        .scrub-trail {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            pointer-events: none;
            animation: trail-fade 0.5s ease-out forwards;
        }
        
        @keyframes trail-fade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }
        
        .brush-trail {
            position: absolute;
            width: 15px;
            height: 15px;
            background: rgba(34, 197, 94, 0.4);
            border-radius: 50%;
            pointer-events: none;
            animation: trail-fade 0.4s ease-out forwards;
        }
        
        .washing-progress {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .washing-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="gameContainer" class="game-container relative w-full bg-white flex flex-col overflow-hidden">

        <!-- Page 1: Intro 1 -->
        <div id="page-1" class="page active flex-col justify-center items-center h-full p-8 text-center">
            <div class="character-container mb-6">
                <img src="maskot.png" alt="Maskot" class="w-[150px] h-[150px] rounded-full object-cover shadow-md">
            </div>
            <div class="bubble w-full max-w-sm">
                <p id="bubble-text-1" class="text-gray-700 text-lg">Halo! Senang bertemu dengan Kalian!</p>
            </div>
            <!-- Fallback button if auto doesn't work -->
            <button id="manual-start" onclick="showPage('page-2')" class="mt-4 btn bg-blue-500 text-white font-bold py-2 px-6 rounded-full shadow-lg" style="display: none;">Mulai Game</button>
        </div>

        <!-- Undo Button -->
        <button id="undo-btn" onclick="undoPage()" class="fixed top-4 left-4 z-50 bg-gray-500/80 hover:bg-gray-600/80 backdrop-blur-md text-white p-3 rounded-full shadow-lg transition-all duration-200 opacity-0 pointer-events-none border border-white/20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </button>

        

        <!-- Page 2: Question 1 -->
        <div id="page-3" class="page flex-col justify-center items-center h-full p-8 text-center">
             <div class="character-container mb-6">
                <img src="maskot.png" alt="Maskot" class="w-[150px] h-[150px] rounded-full object-cover shadow-md">
            </div>
            <div class="board bg-white p-6 rounded-lg shadow-md w-full max-w-sm mb-6">
                <p class="text-gray-800 text-xl font-semibold">Apakah Anda pernah mencuci baju sendiri?</p>
            </div>
            <div class="options-container w-full max-w-sm space-y-3">
                <button onclick="playSound('click'); showPage('page-4')" class="option-btn w-full bg-white text-gray-700 font-semibold py-3 px-4 rounded-lg">Ya, sering mencuci</button>
                <button onclick="playSound('click'); showPage('page-4')" class="option-btn w-full bg-white text-gray-700 font-semibold py-3 px-4 rounded-lg">Jarang mencuci sendiri</button>
            </div>
        </div>
        
        <!-- Page 3: Question 2 -->
        <div id="page-4" class="page flex-col justify-center items-center h-full p-6 text-center">
             <div class="image-container bg-gray-200 rounded-lg w-64 h-64 mb-4 flex items-center justify-center relative overflow-hidden">
                <!-- Dirty Shirt Image -->
                <img id="shirt-image" src="baju-kotor.png" alt="Baju Kotor" class="w-full h-full object-cover rounded-lg">
            </div>
            <div class="bubble w-full max-w-sm mb-4">
                <p class="text-gray-700 text-base">Kalau ada noda yang susah hilang, biasanya pakai apa ya?</p>
                <p class="text-gray-500 text-sm mt-2">Pilih maksimal 4 pilihan (minimal 2)</p>
            </div>
             <div id="q2-options" class="options-container w-full max-w-sm grid grid-cols-3 gap-2 text-xs">
                <button onclick="selectOption(this)" data-correct="true" class="option-btn bg-white text-gray-700 font-semibold py-2 px-3 rounded-lg">Soda Kue</button>
                <button onclick="selectOption(this)" data-correct="true" class="option-btn bg-white text-gray-700 font-semibold py-2 px-3 rounded-lg">Cuka Dapur</button>
                <button onclick="selectOption(this)" data-correct="false" class="option-btn bg-white text-gray-700 font-semibold py-2 px-3 rounded-lg">Air Gula</button>
                <button onclick="selectOption(this)" data-correct="false" class="option-btn bg-white text-gray-700 font-semibold py-2 px-3 rounded-lg">Air Tanah</button>
                <button onclick="selectOption(this)" data-correct="false" class="option-btn bg-white text-gray-700 font-semibold py-2 px-3 rounded-lg">Air Hujan</button>
                <button onclick="selectOption(this)" data-correct="false" class="option-btn bg-white text-gray-700 font-semibold py-2 px-3 rounded-lg">Detergen Cuci Piring</button>
                <button onclick="selectOption(this)" data-correct="false" class="option-btn bg-white text-gray-700 font-semibold py-2 px-3 rounded-lg">Sampo</button>
            </div>
            <div class="mt-4 flex flex-col items-center">
                <p id="selection-counter" class="text-sm text-gray-500 mb-2">Dipilih: 0/4</p>
                <button id="q2-submit" onclick="checkAnswerQ2()" class="btn bg-green-500 text-white font-bold py-2 px-6 rounded-full shadow-lg opacity-50" disabled>Cek Jawaban</button>
            </div>
        </div>

        

        <!-- Page 5: Info -->
        <div id="page-5" class="page flex-col justify-center items-center h-full p-8 text-center bg-blue-50">
             <div class="icon-container mb-4 text-green-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Jawaban yang Benar: Soda Kue + Cuka Dapur</h2>
            <div class="bg-white p-4 rounded-lg shadow-inner text-left max-w-sm w-full">
                <p class="text-gray-600"><strong class="text-blue-600">Soda Kue</strong> bisa menyerap bau dan membantu mengangkat noda berminyak.</p>
                <p class="text-gray-600 mt-2"><strong class="text-green-600">Cuka Dapur</strong> bisa melarutkan kotoran yang menempel dan bekerja sama dengan soda kue.</p>
            </div>
            <button onclick="playSound('click'); showPage('page-6')" class="mt-8 btn bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg">Mari kita coba praktik!</button>
        </div>

        <!-- Page 4: Intro 2 -->
        <div id="page-2" class="page flex-col justify-center items-center h-full p-8 text-center">
            <div class="character-container mb-6">
                <img src="maskot.png" alt="Maskot" class="w-[150px] h-[150px] rounded-full object-cover shadow-md">
            </div>
            <div class="bubble w-full max-w-sm mb-8">
                <p class="text-gray-700 text-lg">Mari kita coba cara membersihkan noda yang mudah!</p>
            </div>
            <button onclick="playSound('click'); showPage('page-3')" class="btn bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg">Baik, mari kita mulai!</button>
        </div>
        
        <!-- Page 6: Experiment -->
        <div id="page-6" class="page flex-col justify-between h-full p-4">
            <h2 class="text-xl font-bold text-center text-gray-800">Pilih Cara Mencuci yang Ingin Dicoba!</h2>
            <div class="experiment-area flex-grow flex flex-col items-center justify-center my-2">
                <!-- Bucket and Fabric -->
                <div class="relative w-48 h-48">
                     <!-- Bucket -->
                    <svg class="w-full h-full" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 20 H90 L80 90 H20 Z" fill="#D9E2EC"/>
                        <rect x="8" y="15" width="84" height="10" rx="5" fill="#B0C4DE"/>
                    </svg>
                     <!-- Water -->
                    <div id="water" class="absolute bottom-[13px] left-[22px] w-[56px] h-0 bg-blue-300 rounded-b-lg transition-all duration-1000"></div>
                     <!-- Fabric in bucket -->
                    <div id="fabric-in-bucket" class="absolute inset-0 flex items-center justify-center opacity-0 transition-opacity">
                         <div class="relative w-24 h-24">
                            <img id="shirt-in-bucket" src="baju-kotor.png" alt="Baju dalam ember" class="w-full h-full object-cover rounded opacity-50">
                        </div>
                    </div>
                     <!-- Bubbles -->
                    <div id="bubbles" class="absolute bottom-[13px] left-[22px] w-[56px] h-0 opacity-0 transition-all duration-1000"></div>
                    
                    <!-- Washing Ingredients -->
                    <div id="washing-ingredients" class="absolute top-2 right-2 flex flex-col gap-2 opacity-0 transition-opacity duration-500">
                        <img id="ingredient-1" src="" alt="" class="draggable-ingredient w-12 h-12 object-cover rounded shadow-lg cursor-grab active:cursor-grabbing" draggable="true">
                        <img id="ingredient-2" src="" alt="" class="draggable-ingredient w-12 h-12 object-cover rounded shadow-lg cursor-grab active:cursor-grabbing" draggable="true">
                        <img id="ingredient-3" src="" alt="" class="draggable-ingredient w-12 h-12 object-cover rounded shadow-lg cursor-grab active:cursor-grabbing" draggable="true">
                    </div>
                    
                    <!-- Drop Zone for Ingredients -->
                    <div id="ingredient-drop-zone" class="absolute inset-0 pointer-events-none">
                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-20 h-20 border-2 border-dashed border-blue-400 rounded-lg bg-blue-100/50 opacity-0 transition-opacity duration-300">
                            <div class="flex items-center justify-center h-full text-blue-600 text-xs font-semibold">Tarik ke sini</div>
                        </div>
                    </div>
                    
                    <!-- Interactive Washing Area -->
                    <div id="washing-area" class="washing-area absolute inset-0 opacity-0 pointer-events-none">
                        <div class="washing-progress">
                            <div id="washing-progress-bar" class="washing-progress-bar"></div>
                        </div>
                    </div>
                </div>
                 <p id="experiment-info" class="mt-2 text-gray-600 text-sm h-10 text-center"></p>
            </div>
            <div class="options bg-gray-50 p-3 rounded-lg">
                <div class="grid grid-cols-3 gap-2 mb-3">
                     <button onclick="runExperiment('deterjen')" class="option-btn text-xs bg-white text-gray-700 font-semibold p-2 rounded-lg text-center">Pakai<br>Deterjen Saja</button>
                     <button onclick="runExperiment('baking_soda_cuka')" class="option-btn text-xs bg-white text-gray-700 font-semibold p-2 rounded-lg text-center">Pakai<br>Soda Kue + Cuka</button>
                     <button onclick="runExperiment('semua')" class="option-btn text-xs bg-white text-gray-700 font-semibold p-2 rounded-lg text-center">Pakai<br>Detergen + Soda Kue + Cuka</button>
                </div>
                <div class="extra-actions flex justify-center gap-4">
                    <button id="action-kucek" onclick="startInteractiveWashing('kucek')" class="action-icon p-3 bg-white rounded-full shadow disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    </button>
                     <button id="action-sikat" onclick="startInteractiveWashing('sikat')" class="action-icon p-3 bg-white rounded-full shadow disabled:opacity-50" disabled>
                        <img src="sikat.png" alt="Sikat" class="h-6 w-6">
                    </button>
                </div>
                <div class="mt-2 text-center">
                    <p id="washing-instruction" class="text-xs text-gray-500">Klik tombol di atas, lalu gosok di area kain untuk mencuci</p>
                </div>
            </div>
        </div>
        
        <!-- Page 7: Results -->
        <div id="page-7" class="page flex-col justify-center items-center h-full p-6 bg-gray-50">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Hasil Eksperimen</h2>
            <div id="result-card" class="result-card p-5 w-full max-w-sm">
                <h3 id="result-method" class="text-lg font-bold text-blue-600"></h3>
                <p id="result-status" class="text-md font-semibold my-2"></p>
                <div class="result-image w-full h-32 bg-gray-100 rounded my-3 flex items-center justify-center relative overflow-hidden">
                    <img id="result-shirt" src="baju-kotor.png" alt="Hasil Cucian" class="w-full h-full object-cover rounded">
                </div>
                <p id="result-explanation" class="text-sm text-gray-600"></p>
            </div>
            <div class="mt-6 flex flex-col items-center gap-3">
                <button id="retry-washing-btn" onclick="retryWashing()" class="btn bg-orange-500 text-white font-bold py-2 px-6 rounded-full shadow-lg" style="display: none;">Coba Mencuci Lagi</button>
                <button id="conclusion-btn" onclick="playSound('click'); showPage('page-8')" class="btn bg-gray-400 text-white font-bold py-2 px-6 rounded-full shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Pilih Metode Mencuci Terlebih Dahulu
                </button>
            </div>
        </div>

        <!-- Page 8: Summary -->
        <div id="page-8" class="page flex-col justify-center items-center h-full p-8 text-center bg-green-50">
            <div class="icon-container mb-4 text-green-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Kesimpulan</h2>
            <div class="bg-white p-4 rounded-lg shadow-inner max-w-sm w-full">
                <p class="text-gray-700">Menggunakan bahan yang tepat bisa membuat pekerjaan mencuci lebih mudah. Tapi ingat, jangan pakai terlalu banyak bahan kimia karena bisa merugikan kesehatan dan lingkungan.</p>
            </div>
            <button onclick="playSound('click'); showPage('page-9')" class="mt-8 btn bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-lg">Info Penting!</button>
        </div>

        <!-- Page 9: Final Info -->
         <div id="page-9" class="page flex-col justify-center items-center h-full p-8 text-center bg-blue-50">
            <div class="icon-container mb-4 text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.24a2 2 0 00-1.806.547a2 2 0 00-.547 1.806l.477 2.387a6 6 0 00.517 3.86l.158.318a6 6 0 00.517 3.86l2.387.477a2 2 0 001.806-.547a2 2 0 00.547-1.806l-.477-2.387a6 6 0 00-.517-3.86l-.158-.318a6 6 0 00-.517-3.86l-2.387-.477zM12 2c-5.523 0-10 4.477-10 10s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z" /></svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Tips Penting</h2>
            <div class="bg-white p-4 rounded-lg shadow-inner max-w-sm w-full">
                <p class="text-gray-700">Air bekas <strong class="text-green-600">soda kue & cuka dapur</strong> aman untuk tanaman. Tapi air bekas <strong class="text-red-500">deterjen</strong> bisa mencemari air jika dibuang sembarangan. Buanglah di tempat yang tepat!</p>
            </div>
            <button onclick="playSound('click'); showPage('page-10')" class="mt-8 btn bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg">Selesai!</button>
        </div>

        <!-- Page 10: Ending -->
        <div id="page-10" class="page flex-col justify-center items-center h-full p-8 text-center">
            <div class="icon-container mb-4 text-yellow-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-4">Bagus Sekali!</h1>
            <button onclick="playSound('click'); restartGame()" class="btn bg-gray-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">Coba Lagi</button>
        </div>

    </div>

    <script>
        let currentPage = 'page-1';
        let selectedAnswersQ2 = [];
        let pageHistory = ['page-1']; // Track page navigation history
        let synth;
        let gameProgress = {
            currentPage: 'page-1',
            selectedAnswersQ2: [],
            currentExperiment: null,
            actionCount: 0,
            hasCompletedIntro: false,
            pageHistory: ['page-1']
        };


        // Initialize sound synth on the first user interaction
        function initSound() {
            if (!synth) {
                synth = new Tone.Synth().toDestination();
                // Play a silent note to "warm up" the audio context
                Tone.start();
                console.log("Audio Context Started");
            }
        }
        
        // --- Sound Effects ---
        const sounds = {
            click: () => synth.triggerAttackRelease("C5", "8n"),
            mix: () => {
                const noise = new Tone.Noise("pink").start();
                const filter = new Tone.AutoFilter("4n").toDestination().start();
                noise.connect(filter);
                setTimeout(() => noise.stop(), 500);
            },
            kucek: () => {
                 const noise = new Tone.Noise("white").toDestination();
                 const env = new Tone.AmplitudeEnvelope({
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0,
                }).connect(noise.destination);
                 noise.start();
                 env.triggerAttack();
                 setTimeout(() => noise.stop(), 150);
            },
            sikat: () => {
                 const noise = new Tone.Noise("brown").toDestination();
                 const env = new Tone.AmplitudeEnvelope({
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0,
                }).connect(noise.destination);
                 noise.start();
                 env.triggerAttack();
                 setTimeout(() => noise.stop(), 100);
            },
            correct: () => synth.triggerAttackRelease("G5", "8n"),
            wrong: () => synth.triggerAttackRelease("C3", "8n"),
            success: () => {
                 synth.triggerAttackRelease("C5", "8n", Tone.now());
                 synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.2);
                 synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.4);
            }
        };

        function playSound(soundName) {
            if (sounds[soundName] && typeof Tone !== 'undefined' && Tone.context.state === 'running') {
                sounds[soundName]();
            }
        }

        // --- Progress Management ---
        function saveProgress() {
            gameProgress.currentPage = currentPage;
            gameProgress.selectedAnswersQ2 = selectedAnswersQ2;
            gameProgress.currentExperiment = currentExperiment;
            gameProgress.actionCount = actionCount;
            localStorage.setItem('chemistryGameProgress', JSON.stringify(gameProgress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('chemistryGameProgress');
            if (saved) {
                try {
                    gameProgress = JSON.parse(saved);
                    currentPage = gameProgress.currentPage;
                    selectedAnswersQ2 = gameProgress.selectedAnswersQ2 || [];
                    currentExperiment = gameProgress.currentExperiment;
                    actionCount = gameProgress.actionCount || 0;
                    pageHistory = gameProgress.pageHistory || ['page-1'];
                    return true;
                } catch (e) {
                    console.error('Error loading progress:', e);
                }
            }
            return false;
        }

        function clearProgress() {
            localStorage.removeItem('chemistryGameProgress');
            gameProgress = {
                currentPage: 'page-1',
                selectedAnswersQ2: [],
                currentExperiment: null,
                actionCount: 0,
                hasCompletedIntro: false,
                pageHistory: ['page-1']
            };
            pageHistory = ['page-1'];
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            console.log("Switching to page:", pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                // Add to history if not already the current page
                if (pageHistory[pageHistory.length - 1] !== pageId) {
                    pageHistory.push(pageId);
                    gameProgress.pageHistory = [...pageHistory];
                }
                
                // Update undo button visibility
                updateUndoButton();
                
                // Initialize counter when showing page 4
                if (pageId === 'page-4') {
                    const counter = document.getElementById('selection-counter');
                    if (counter) {
                        counter.textContent = `Dipilih: ${selectedAnswersQ2.length}/4`;
                        if (selectedAnswersQ2.length >= 4) {
                            counter.classList.add('text-red-500');
                            counter.classList.remove('text-gray-500');
                        } else {
                            counter.classList.add('text-gray-500');
                            counter.classList.remove('text-red-500');
                        }
                    }
                }
                
                saveProgress(); // Save progress setiap kali pindah halaman
                console.log("Successfully switched to page:", pageId);
            } else {
                console.error('Page not found:', pageId);
            }
        }

        // --- Game Logic ---

        // Initialize game on page load
        function initializeGame() {
            console.log("Initializing game...");
            
            // Initialize counter on page 4
            const counter = document.getElementById('selection-counter');
            if (counter) {
                counter.textContent = `Dipilih: 0/4`;
                counter.classList.add('text-gray-500');
                counter.classList.remove('text-red-500');
            }
            
            // Try to load saved progress
            const hasProgress = loadProgress();
            
            if (hasProgress && gameProgress.hasCompletedIntro) {
                // Skip intro if already completed
                console.log("Loading saved progress from page:", currentPage);
                restoreGameState();
                showPage(currentPage);
            } else {
                // Start fresh with intro sequence
                console.log("Starting fresh game with intro...");
                runIntroSequence();
            }
        }

        // Restore game state from saved progress
        function restoreGameState() {
            // Restore selected answers for Q2
            if (selectedAnswersQ2.length > 0) {
                selectedAnswersQ2.forEach(answer => {
                    const buttons = document.querySelectorAll('#q2-options button');
                    buttons.forEach(btn => {
                        if (btn.textContent.trim().toLowerCase() === answer) {
                            btn.classList.add('selected');
                        }
                    });
                });
                
                // Update selection counter
                const counter = document.getElementById('selection-counter');
                if (counter) {
                    counter.textContent = `Dipilih: ${selectedAnswersQ2.length}/4`;
                    // Set color based on count
                    if (selectedAnswersQ2.length >= 4) {
                        counter.classList.add('text-red-500');
                        counter.classList.remove('text-gray-500');
                    } else {
                        counter.classList.add('text-gray-500');
                        counter.classList.remove('text-red-500');
                    }
                }
                
                // Enable submit button if answers are selected
                const submitBtn = document.getElementById('q2-submit');
                if (submitBtn && selectedAnswersQ2.length >= 2) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50');
                }
            } else {
                // Initialize counter even if no selections
                const counter = document.getElementById('selection-counter');
                if (counter) {
                    counter.textContent = `Dipilih: 0/4`;
                    counter.classList.add('text-gray-500');
                    counter.classList.remove('text-red-500');
                }
            }

            // Restore experiment state if on experiment page
            if (currentPage === 'page-6' && currentExperiment) {
                const selectedBtn = document.querySelector(`button[onclick="runExperiment('${currentExperiment}')"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
                
                // Restore experiment visuals
                const water = document.getElementById('water');
                const fabric = document.getElementById('fabric-in-bucket');
                const info = document.getElementById('experiment-info');
                
                if (water) water.style.height = '60px';
                if (fabric) fabric.style.opacity = '1';
                if (info) info.textContent = "Bahan sudah tercampur. Silakan kucek atau sikat nodanya!";
                
                // Enable action buttons
                const kucekBtn = document.getElementById('action-kucek');
                const sikatBtn = document.getElementById('action-sikat');
                if (kucekBtn) kucekBtn.disabled = false;
                if (sikatBtn) sikatBtn.disabled = false;
            }
            
            // Update undo button visibility
            updateUndoButton();
        }

        // Typing effect for intro
        async function runIntroSequence() {
            try {
                console.log("Starting intro sequence...");
                const bubbleElement = document.getElementById('bubble-text-1');
                if (!bubbleElement) {
                    console.error("Bubble element not found!");
                    // Fallback: just go to page 2
                    setTimeout(() => showPage('page-2'), 1000);
                    return;
                }
                
                const bubbleText = ["Halo! Senang bertemu dengan kalian!", "Mari belajar cara praktis membersihkan noda!"];
                const sleep = (ms) => new Promise(res => setTimeout(res, ms));

                const typeSentence = async (sentence) => {
                    console.log("Typing:", sentence);
                    if (bubbleElement) {
                        bubbleElement.textContent = '';
                        for (let i = 0; i < sentence.length; i++) {
                            bubbleElement.textContent += sentence.charAt(i);
                            await sleep(50);
                        }
                    }
                };

                // Start typing the first sentence
                await typeSentence(bubbleText[0]);
                console.log("First sentence completed");
                // Wait after the first sentence
                await sleep(2000);
                
                // Start typing the second sentence
                await typeSentence(bubbleText[1]);
                console.log("Second sentence completed");
                // Wait after the second sentence
                await sleep(2000);

                // Mark intro as completed and save progress
                gameProgress.hasCompletedIntro = true;
                saveProgress();

                // Transition to the next page
                console.log("Moving to page 2...");
                showPage('page-2');
            } catch (error) {
                console.error("Error in intro sequence:", error);
                // Show manual start button as fallback
                const manualBtn = document.getElementById('manual-start');
                if (manualBtn) {
                    manualBtn.style.display = 'block';
                }
            }
        }
        
        // Add click listener for sound initialization
        document.body.addEventListener('click', initSound, { once: true });
        
        // Initialize game when page loads
        window.addEventListener('load', () => {
            setTimeout(initializeGame, 100);
        });
        
        // Show manual start button after 10 seconds if still on page 1
        setTimeout(() => {
            if (currentPage === 'page-1') {
                console.log("Auto intro failed, showing manual button");
                const manualBtn = document.getElementById('manual-start');
                if (manualBtn) {
                    manualBtn.style.display = 'block';
                }
            }
        }, 10000);


        function selectOption(button) {
            playSound('click');
            const answer = button.textContent.trim().toLowerCase();
            
            if (selectedAnswersQ2.includes(answer)) {
                // Deselect if already selected
                selectedAnswersQ2 = selectedAnswersQ2.filter(a => a !== answer);
                button.classList.remove('selected');
            } else {
                // Select if not already selected and under limit
                if (selectedAnswersQ2.length < 4) {
                    selectedAnswersQ2.push(answer);
                    button.classList.add('selected');
                } else {
                    // Show visual feedback that limit is reached
                    button.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        button.style.transform = 'scale(1)';
                    }, 150);
                    return; // Don't proceed if limit reached
                }
            }

            // Update selection counter
            const counter = document.getElementById('selection-counter');
            if (counter) {
                counter.textContent = `Dipilih: ${selectedAnswersQ2.length}/4`;
                // Change color based on selection count
                if (selectedAnswersQ2.length >= 4) {
                    counter.classList.add('text-red-500');
                    counter.classList.remove('text-gray-500');
                } else {
                    counter.classList.add('text-gray-500');
                    counter.classList.remove('text-red-500');
                }
            }

            // Save progress when answers change
            saveProgress();

            const submitBtn = document.getElementById('q2-submit');
            if (submitBtn) {
                if (selectedAnswersQ2.length >= 2) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50');
                } else {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50');
                }
            }
        }

        function checkAnswerQ2() {
            const correctAnswers = ["soda kue", "cuka dapur"];
            const hasCorrectAnswers = correctAnswers.every(correctAnswer => selectedAnswersQ2.includes(correctAnswer));
            
            if (hasCorrectAnswers && selectedAnswersQ2.length >= 2) {
                playSound('correct');
                showPage('page-5');
            } else {
                playSound('wrong');
                alert("Pastikan Anda memilih bahan kimia yang ramah lingkungan.");
            }
        }
        
        const experimentResults = {
            deterjen: {
                method: "Pakai Deterjen Saja",
                result: "Noda berkurang tapi masih terlihat",
                explanation: "Deterjen biasa bisa mengangkat sebagian noda, tapi untuk noda yang sangat membandel kurang kuat. Deterjen bekerja dengan cara melarutkan kotoran berminyak.",
                stainOpacity: 0.4
            },
            baking_soda_cuka: {
                method: "Pakai Soda Kue + Cuka Dapur",
                result: "Noda masih terlihat",
                explanation: "Soda kue dan cuka dapur bereaksi menghasilkan gelembung yang membantu mengangkat kotoran. Tapi tanpa deterjen, noda berminyak masih sulit hilang sepenuhnya.",
                stainOpacity: 0.6
            },
            semua: {
                method: "Pakai Cuka Soda Kue Detergen",
                result: "Noda hilang bersih!",
                explanation: "Kombinasi terbaik! Soda kue dan cuka dapur membuat gelembung yang membantu mengangkat kotoran, sementara Detergen mengikat dan membawa kotoran keluar dari kain.",
                stainOpacity: 0
            }
        }

        let currentExperiment = null;

        function runExperiment(method) {
             // Reset visuals
            document.querySelectorAll('#page-6 .option-btn').forEach(b => b.classList.remove('selected'));
            const selectedBtn = document.querySelector(`button[onclick="runExperiment('${method}')"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            currentExperiment = method;
            actionCount = 0; // Reset action count for new experiment
            
            // Enable conclusion button only for correct method (semua)
            updateConclusionButton(method === 'semua');
            
            // Save progress
            saveProgress();
            
            const info = document.getElementById('experiment-info');
            const water = document.getElementById('water');
            const fabric = document.getElementById('fabric-in-bucket');
            const bubbles = document.getElementById('bubbles');
            const ingredients = document.getElementById('washing-ingredients');
            const ingredient1 = document.getElementById('ingredient-1');
            const ingredient2 = document.getElementById('ingredient-2');
            const ingredient3 = document.getElementById('ingredient-3');
            
            // Show ingredients based on method
            showWashingIngredients(method);
            
            if (info) info.textContent = "Masukkan kain dan bahan ke dalam ember...";
            if (water) water.style.height = '0px';
            if (fabric) fabric.style.opacity = '0';
            
            setTimeout(() => {
                playSound('mix');
                if (water) {
                    water.style.height = '60px';
                    water.classList.add('water-ripple');
                }
                if (fabric) fabric.style.opacity = '1';
                if (info) info.textContent = "Bahan sudah dicampur dengan air.";
                
                // Show ingredients
                if (ingredients) ingredients.style.opacity = '1';
                
                // Create initial bubbles when mixing
                createBubbles();
                createSplash();
            }, 500);

            setTimeout(() => {
                if (info) info.textContent = "Tarik bahan ke dalam ember terlebih dahulu!";
                const kucekBtn = document.getElementById('action-kucek');
                const sikatBtn = document.getElementById('action-sikat');
                if (kucekBtn) kucekBtn.disabled = true;
                if (sikatBtn) sikatBtn.disabled = true;
            }, 2000);
        }
        
        function showWashingIngredients(method) {
            const ingredient1 = document.getElementById('ingredient-1');
            const ingredient2 = document.getElementById('ingredient-2');
            const ingredient3 = document.getElementById('ingredient-3');
            
            // Hide all ingredients first
            if (ingredient1) ingredient1.style.display = 'none';
            if (ingredient2) ingredient2.style.display = 'none';
            if (ingredient3) ingredient3.style.display = 'none';
            
            // Reset ingredients in bucket
            ingredientsInBucket = [];
            
            switch(method) {
                case 'deterjen':
                    if (ingredient1) {
                        ingredient1.src = 'Detergen.png';
                        ingredient1.alt = 'Detergen';
                        ingredient1.style.display = 'block';
                        ingredient1.dataset.ingredientType = 'Detergen';
                    }
                    break;
                    
                case 'baking_soda_cuka':
                    if (ingredient1) {
                        ingredient1.src = 'bsoda.png';
                        ingredient1.alt = 'Baking Soda';
                        ingredient1.style.display = 'block';
                        ingredient1.dataset.ingredientType = 'bsoda';
                    }
                    if (ingredient2) {
                        ingredient2.src = 'cuka.png';
                        ingredient2.alt = 'Cuka';
                        ingredient2.style.display = 'block';
                        ingredient2.dataset.ingredientType = 'cuka';
                    }
                    break;
                    
                case 'semua':
                    if (ingredient1) {
                        ingredient1.src = 'Detergen.png';
                        ingredient1.alt = 'Detergen';
                        ingredient1.style.display = 'block';
                        ingredient1.dataset.ingredientType = 'Detergen';
                    }
                    if (ingredient2) {
                        ingredient2.src = 'bsoda.png';
                        ingredient2.alt = 'Baking Soda';
                        ingredient2.style.display = 'block';
                        ingredient2.dataset.ingredientType = 'bsoda';
                    }
                    if (ingredient3) {
                        ingredient3.src = 'cuka.png';
                        ingredient3.alt = 'Cuka';
                        ingredient3.style.display = 'block';
                        ingredient3.dataset.ingredientType = 'cuka';
                    }
                    break;
            }
            
            // Setup drag and drop
            setupDragAndDrop();
        }
        
        function setupDragAndDrop() {
            const ingredients = document.querySelectorAll('.draggable-ingredient');
            dropZone = document.querySelector('#ingredient-drop-zone .absolute');
            
            ingredients.forEach(ingredient => {
                // Remove existing listeners
                ingredient.removeEventListener('dragstart', handleDragStart);
                ingredient.removeEventListener('dragend', handleDragEnd);
                ingredient.removeEventListener('touchstart', handleTouchStart);
                ingredient.removeEventListener('touchmove', handleTouchMove);
                ingredient.removeEventListener('touchend', handleTouchEnd);
                
                // Add new listeners
                ingredient.addEventListener('dragstart', handleDragStart);
                ingredient.addEventListener('dragend', handleDragEnd);
                ingredient.addEventListener('touchstart', handleTouchStart);
                ingredient.addEventListener('touchmove', handleTouchMove);
                ingredient.addEventListener('touchend', handleTouchEnd);
            });
            
            if (dropZone) {
                dropZone.removeEventListener('dragover', handleDragOver);
                dropZone.removeEventListener('drop', handleDrop);
                dropZone.removeEventListener('dragenter', handleDragEnter);
                dropZone.removeEventListener('dragleave', handleDragLeave);
                
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('drop', handleDrop);
                dropZone.addEventListener('dragenter', handleDragEnter);
                dropZone.addEventListener('dragleave', handleDragLeave);
            }
        }
        
        function handleDragStart(e) {
            draggedIngredient = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            
            // Show drop zone
            if (dropZone) {
                dropZone.classList.add('drop-zone-active');
            }
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIngredient = null;
            
            // Hide drop zone
            if (dropZone) {
                dropZone.classList.remove('drop-zone-active', 'drop-zone-highlight');
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            if (dropZone) {
                dropZone.classList.add('drop-zone-highlight');
            }
        }
        
        function handleDragLeave(e) {
            if (dropZone && !dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drop-zone-highlight');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            
            if (dropZone) {
                dropZone.classList.remove('drop-zone-highlight');
            }
            
            if (draggedIngredient) {
                const ingredientType = draggedIngredient.dataset.ingredientType;
                
                // Check if ingredient is already in bucket
                if (!ingredientsInBucket.includes(ingredientType)) {
                    ingredientsInBucket.push(ingredientType);
                    
                    // Hide the dragged ingredient
                    draggedIngredient.style.opacity = '0.3';
                    draggedIngredient.style.pointerEvents = 'none';
                    
                    // Play sound
                    playSound('mix');
                    
                    // Show success feedback
                    showIngredientAdded(ingredientType);
                    
                    // Check if all ingredients are added
                    checkAllIngredientsAdded();
                }
            }
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            draggedIngredient = e.target;
            e.target.classList.add('dragging');
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (draggedIngredient) {
                const touch = e.touches[0];
                const rect = draggedIngredient.getBoundingClientRect();
                draggedIngredient.style.position = 'fixed';
                draggedIngredient.style.left = (touch.clientX - rect.width / 2) + 'px';
                draggedIngredient.style.top = (touch.clientY - rect.height / 2) + 'px';
                draggedIngredient.style.zIndex = '1000';
                
                // Show drop zone
                if (dropZone) {
                    dropZone.classList.add('drop-zone-active');
                }
            }
        }
        
        function handleTouchEnd(e) {
            if (draggedIngredient) {
                const touch = e.changedTouches[0];
                const dropZoneRect = dropZone.getBoundingClientRect();
                
                // Check if dropped on drop zone
                if (touch.clientX >= dropZoneRect.left && 
                    touch.clientX <= dropZoneRect.right && 
                    touch.clientY >= dropZoneRect.top && 
                    touch.clientY <= dropZoneRect.bottom) {
                    
                    const ingredientType = draggedIngredient.dataset.ingredientType;
                    
                    if (!ingredientsInBucket.includes(ingredientType)) {
                        ingredientsInBucket.push(ingredientType);
                        draggedIngredient.style.opacity = '0.3';
                        draggedIngredient.style.pointerEvents = 'none';
                        playSound('mix');
                        showIngredientAdded(ingredientType);
                        checkAllIngredientsAdded();
                    }
                }
                
                // Reset position
                draggedIngredient.style.position = '';
                draggedIngredient.style.left = '';
                draggedIngredient.style.top = '';
                draggedIngredient.style.zIndex = '';
                draggedIngredient.classList.remove('dragging');
                
                if (dropZone) {
                    dropZone.classList.remove('drop-zone-active', 'drop-zone-highlight');
                }
                
                draggedIngredient = null;
            }
        }
        
        function showIngredientAdded(ingredientType) {
            const ingredientNames = {
                'Detergen': 'Detergen',
                'bsoda': 'Soda Kue',
                'cuka': 'Cuka'
            };
            
            // Create temporary feedback
            const feedback = document.createElement('div');
            feedback.textContent = `${ingredientNames[ingredientType]} ditambahkan!`;
            feedback.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-4 py-2 rounded-full text-sm font-semibold z-50';
            feedback.style.animation = 'fadeInOut 2s ease-in-out';
            
            const experimentArea = document.querySelector('.experiment-area');
            if (experimentArea) {
                experimentArea.appendChild(feedback);
                setTimeout(() => feedback.remove(), 2000);
            }
        }
        
        function checkAllIngredientsAdded() {
            const requiredIngredients = getRequiredIngredients();
            const allAdded = requiredIngredients.every(ingredient => 
                ingredientsInBucket.includes(ingredient)
            );
            
            if (allAdded) {
                // Enable washing buttons
                const kucekBtn = document.getElementById('action-kucek');
                const sikatBtn = document.getElementById('action-sikat');
                if (kucekBtn) kucekBtn.disabled = false;
                if (sikatBtn) sikatBtn.disabled = false;
                
                // Update instruction
                const info = document.getElementById('experiment-info');
                if (info) info.textContent = "Semua bahan sudah ditambahkan! Sekarang kucek atau sikat nodanya!";
                
                // Hide drop zone
                if (dropZone) {
                    dropZone.classList.remove('drop-zone-active');
                }
            }
        }
        
        function getRequiredIngredients() {
            switch(currentExperiment) {
                case 'deterjen':
                    return ['Detergen'];
                case 'baking_soda_cuka':
                    return ['bsoda', 'cuka'];
                case 'semua':
                    return ['Detergen', 'bsoda', 'cuka'];
                default:
                    return [];
            }
        }
        
        function updateConclusionButton(isEnabled) {
            const conclusionBtn = document.getElementById('conclusion-btn');
            if (!conclusionBtn) return;
            
            if (isEnabled) {
                // Enable button
                conclusionBtn.disabled = false;
                conclusionBtn.classList.remove('bg-gray-400', 'opacity-50', 'cursor-not-allowed');
                conclusionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                conclusionBtn.textContent = 'Lihat Kesimpulan';
            } else {
                // Disable button
                conclusionBtn.disabled = true;
                conclusionBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                conclusionBtn.classList.add('bg-gray-400', 'opacity-50', 'cursor-not-allowed');
                conclusionBtn.textContent = 'Pilih Metode Mencuci Terlebih Dahulu';
            }
        }
        
        function updateUndoButton() {
            const undoBtn = document.getElementById('undo-btn');
            if (!undoBtn) return;
            
            // Show undo button if there's more than one page in history
            if (pageHistory.length > 1) {
                undoBtn.classList.remove('opacity-0', 'pointer-events-none');
                undoBtn.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                undoBtn.classList.add('opacity-0', 'pointer-events-none');
                undoBtn.classList.remove('opacity-100', 'pointer-events-auto');
            }
        }
        
        function undoPage() {
            playSound('click');
            
            // Don't undo if we're at the first page
            if (pageHistory.length <= 1) return;
            
            // Remove current page from history
            pageHistory.pop();
            gameProgress.pageHistory = [...pageHistory];
            
            // Go to previous page
            const previousPage = pageHistory[pageHistory.length - 1];
            if (previousPage) {
                showPage(previousPage);
            }
        }

        let actionCount = 0;
        let washingAnimation = null;
        let currentWashingMode = null;
        let washingProgress = 0;
        let isWashing = false;
        let washingArea = null;
        let draggedIngredient = null;
        let ingredientsInBucket = [];
        let dropZone = null;
        
        function createBubbles() {
            const bucket = document.querySelector('.relative.w-48.h-48');
            if (!bucket) return;
            
            for (let i = 0; i < 5; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble-animation';
                bubble.style.left = Math.random() * 40 + 30 + '%';
                bubble.style.bottom = '20px';
                bubble.style.animationDelay = Math.random() * 2 + 's';
                bubble.style.animationDuration = (Math.random() * 1 + 1.5) + 's';
                bucket.appendChild(bubble);
                
                // Remove bubble after animation
                setTimeout(() => {
                    if (bubble.parentNode) {
                        bubble.parentNode.removeChild(bubble);
                    }
                }, 3000);
            }
        }
        
        function createSplash() {
            const bucket = document.querySelector('.relative.w-48.h-48');
            if (!bucket) return;
            
            for (let i = 0; i < 3; i++) {
                const splash = document.createElement('div');
                splash.className = 'splash-effect';
                splash.style.left = Math.random() * 40 + 30 + '%';
                splash.style.bottom = '30px';
                splash.style.animationDelay = Math.random() * 0.5 + 's';
                bucket.appendChild(splash);
                
                // Remove splash after animation
                setTimeout(() => {
                    if (splash.parentNode) {
                        splash.parentNode.removeChild(splash);
                    }
                }, 1000);
            }
        }
        
        function startWashingAnimation() {
            const fabric = document.getElementById('fabric-in-bucket');
            if (fabric) {
                fabric.classList.add('fabric-wash');
            }
            
            const water = document.getElementById('water');
            if (water) {
                water.classList.add('water-ripple');
            }
            
            // Create bubbles continuously
            washingAnimation = setInterval(() => {
                createBubbles();
                createSplash();
            }, 800);
        }
        
        function stopWashingAnimation() {
            const fabric = document.getElementById('fabric-in-bucket');
            if (fabric) {
                fabric.classList.remove('fabric-wash');
            }
            
            const water = document.getElementById('water');
            if (water) {
                water.classList.remove('water-ripple');
            }
            
            if (washingAnimation) {
                clearInterval(washingAnimation);
                washingAnimation = null;
            }
        }
        
        function startInteractiveWashing(mode) {
            currentWashingMode = mode;
            isWashing = true;
            washingProgress = 0;
            
            // Get washing area
            washingArea = document.getElementById('washing-area');
            if (!washingArea) return;
            
            // Enable interactive area
            washingArea.style.opacity = '1';
            washingArea.style.pointerEvents = 'auto';
            
            // Set cursor based on mode
            if (mode === 'kucek') {
                washingArea.classList.add('scrub-cursor');
                washingArea.classList.remove('brush-cursor');
                playSound('kucek');
            } else if (mode === 'sikat') {
                washingArea.classList.add('brush-cursor');
                washingArea.classList.remove('scrub-cursor');
                playSound('sikat');
            }
            
            // Add event listeners
            washingArea.addEventListener('mousedown', startWashing);
            washingArea.addEventListener('mousemove', continueWashing);
            washingArea.addEventListener('mouseup', stopWashing);
            washingArea.addEventListener('mouseleave', stopWashing);
            
            // Touch events for mobile
            washingArea.addEventListener('touchstart', handleTouch);
            washingArea.addEventListener('touchmove', handleTouch);
            washingArea.addEventListener('touchend', stopWashing);
            
            // Update instruction
            const instruction = document.getElementById('washing-instruction');
            if (instruction) {
                instruction.textContent = mode === 'kucek' ? 
                    'Tarik mouse di area kain untuk mengucek noda' : 
                    'Tarik mouse di area kain untuk menyikat noda';
            }
        }
        
        function startWashing(e) {
            if (!isWashing) return;
            e.preventDefault();
            performWashingAction(e.clientX, e.clientY);
        }
        
        function continueWashing(e) {
            if (!isWashing) return;
            e.preventDefault();
            performWashingAction(e.clientX, e.clientY);
        }
        
        function stopWashing() {
            if (!isWashing) return;
            isWashing = false;
            
            // Disable interactive area
            if (washingArea) {
                washingArea.style.opacity = '0';
                washingArea.style.pointerEvents = 'none';
                washingArea.classList.remove('scrub-cursor', 'brush-cursor');
                
                // Remove event listeners
                washingArea.removeEventListener('mousedown', startWashing);
                washingArea.removeEventListener('mousemove', continueWashing);
                washingArea.removeEventListener('mouseup', stopWashing);
                washingArea.removeEventListener('mouseleave', stopWashing);
                washingArea.removeEventListener('touchstart', handleTouch);
                washingArea.removeEventListener('touchmove', handleTouch);
                washingArea.removeEventListener('touchend', stopWashing);
            }
            
            // Check if enough washing done
            if (washingProgress >= 100) {
                actionCount++;
                checkWashingComplete();
            }
        }
        
        function handleTouch(e) {
            e.preventDefault();
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                if (e.type === 'touchstart' || e.type === 'touchmove') {
                    performWashingAction(touch.clientX, touch.clientY);
                }
            }
        }
        
        function performWashingAction(x, y) {
            if (!isWashing || !washingArea) return;
            
            // Get position relative to washing area
            const rect = washingArea.getBoundingClientRect();
            const relativeX = x - rect.left;
            const relativeY = y - rect.top;
            
            // Create trail effect
            createWashingTrail(relativeX, relativeY);
            
            // Update progress
            washingProgress = Math.min(washingProgress + 2, 100);
            updateWashingProgress();
            
            // Update shirt image based on progress
            const shirtInBucket = document.getElementById('shirt-in-bucket');
            if (shirtInBucket) {
                if (washingProgress >= 50) {
                    // Change to cleaner shirt when progress is halfway
                    shirtInBucket.src = 'baju-bersih.png';
                    shirtInBucket.alt = 'Baju Sedang Dibersihkan';
                }
            }
            
            // Create bubbles occasionally
            if (Math.random() < 0.3) {
                createBubbles();
            }
        }
        
        function createWashingTrail(x, y) {
            if (!washingArea) return;
            
            const trail = document.createElement('div');
            trail.className = currentWashingMode === 'kucek' ? 'scrub-trail' : 'brush-trail';
            trail.style.left = x + 'px';
            trail.style.top = y + 'px';
            
            washingArea.appendChild(trail);
            
            // Remove trail after animation
            setTimeout(() => {
                if (trail.parentNode) {
                    trail.parentNode.removeChild(trail);
                }
            }, 500);
        }
        
        function updateWashingProgress() {
            const progressBar = document.getElementById('washing-progress-bar');
            if (progressBar) {
                progressBar.style.width = washingProgress + '%';
            }
        }
        
        function checkWashingComplete() {
            const kucekBtn = document.getElementById('action-kucek');
            const sikatBtn = document.getElementById('action-sikat');
            const info = document.getElementById('experiment-info');
            
            if (kucekBtn) kucekBtn.disabled = true;
            if (sikatBtn) sikatBtn.disabled = true;
            if (info) info.textContent = "Melihat hasil cucian...";
            
            // Don't reset progress here, keep it for result display
            // washingProgress will be reset in retryWashing() or restartGame()
            
            setTimeout(() => showResult(currentExperiment), 1500);
        }
        
        function performAction(action) {
            // Legacy function for backward compatibility
            if (action === 'kucek') playSound('kucek');
            if (action === 'sikat') playSound('sikat');

            actionCount++;
            
            // Add washing animation to action buttons
            const kucekBtn = document.getElementById('action-kucek');
            const sikatBtn = document.getElementById('action-sikat');
            if (action === 'kucek' && kucekBtn) kucekBtn.classList.add('washing');
            if (action === 'sikat' && sikatBtn) sikatBtn.classList.add('washing');
            
            // Start washing animation
            startWashingAnimation();
            
            // Save progress after each action
            saveProgress();
            
            const stain = document.getElementById('stain-2');
            if (stain) {
                let currentOpacity = parseFloat(stain.style.opacity) || 1.0;
                stain.style.opacity = currentOpacity * 0.8;
                
                // Add stain fade animation
                stain.classList.add('stain-fade');
                setTimeout(() => {
                    stain.classList.remove('stain-fade');
                }, 1000);
            }

            // Stop animation after 1 second
            setTimeout(() => {
                stopWashingAnimation();
                // Remove washing animation from buttons
                if (kucekBtn) kucekBtn.classList.remove('washing');
                if (sikatBtn) sikatBtn.classList.remove('washing');
            }, 1000);

            if (actionCount >= 2) {
                const info = document.getElementById('experiment-info');
                
                if (kucekBtn) kucekBtn.disabled = true;
                if (sikatBtn) sikatBtn.disabled = true;
                if (info) info.textContent = "Melihat hasil cucian...";
                
                setTimeout(() => showResult(currentExperiment), 1500);
            }
        }
        
        function showResult(method) {
            const resultData = experimentResults[method];
            if (!resultData) {
                console.error('No result data for method:', method);
                return;
            }
            
            const methodEl = document.getElementById('result-method');
            const statusEl = document.getElementById('result-status');
            const explanationEl = document.getElementById('result-explanation');
            const resultShirt = document.getElementById('result-shirt');
            const resultCard = document.getElementById('result-card');
            const retryBtn = document.getElementById('retry-washing-btn');
            
            if (methodEl) methodEl.textContent = resultData.method;
            if (statusEl) {
                statusEl.textContent = resultData.result;
                statusEl.className = 'text-md font-semibold my-2 ' + (resultData.stainOpacity === 0 ? 'text-green-600' : 'text-red-500');
            }
            if (explanationEl) explanationEl.textContent = resultData.explanation;
            
            // Change shirt image based on result
            if (resultShirt) {
                if (resultData.stainOpacity === 0) {
                    resultShirt.src = 'baju-bersih.png';
                    resultShirt.alt = 'Baju Bersih';
                } else {
                    resultShirt.src = 'baju-kotor.png';
                    resultShirt.alt = 'Baju Masih Kotor';
                }
            }
            
            // Show retry button only if result is not successful
            if (retryBtn) {
                if (resultData.stainOpacity === 0) {
                    retryBtn.style.display = 'none';
                } else {
                    retryBtn.style.display = 'block';
                }
            }
            
            // Add animation based on result
            if (resultCard) {
                if (resultData.stainOpacity === 0) {
                    resultCard.classList.add('result-success');
                    playSound('success');
                } else {
                    resultCard.classList.add('result-fail');
                }
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    resultCard.classList.remove('result-success', 'result-fail');
                }, 1000);
            }

            showPage('page-7');
        }

        function retryWashing() {
            playSound('click');
            
            // Reset washing state
            actionCount = 0;
            washingProgress = 0;
            isWashing = false;
            currentWashingMode = null;
            
            // Reset experiment visuals
            const water = document.getElementById('water');
            const fabric = document.getElementById('fabric-in-bucket');
            const shirtInBucket = document.getElementById('shirt-in-bucket');
            const info = document.getElementById('experiment-info');
            const kucekBtn = document.getElementById('action-kucek');
            const sikatBtn = document.getElementById('action-sikat');
            const progressBar = document.getElementById('washing-progress-bar');
            const ingredients = document.getElementById('washing-ingredients');
            
            if (water) water.style.height = '60px';
            if (fabric) fabric.style.opacity = '1';
            if (shirtInBucket) {
                shirtInBucket.src = 'baju-kotor.png';
                shirtInBucket.alt = 'Baju dalam ember';
            }
            if (info) info.textContent = "Sekarang kucek atau sikat nodanya!";
            if (kucekBtn) kucekBtn.disabled = false;
            if (sikatBtn) sikatBtn.disabled = false;
            if (progressBar) progressBar.style.width = '0%';
            
            // Show ingredients again
            if (ingredients) ingredients.style.opacity = '1';
            
            // Reset drag and drop
            ingredientsInBucket = [];
            const ingredientElements = document.querySelectorAll('.draggable-ingredient');
            ingredientElements.forEach(ingredient => {
                ingredient.style.opacity = '1';
                ingredient.style.pointerEvents = 'auto';
            });
            
            // Reset conclusion button
            updateConclusionButton(currentExperiment === 'semua');
            
            // Reset washing area
            if (washingArea) {
                washingArea.style.opacity = '0';
                washingArea.style.pointerEvents = 'none';
                washingArea.classList.remove('scrub-cursor', 'brush-cursor');
            }
            
            // Go back to experiment page
            showPage('page-6');
        }

        function restartGame() {
            // Clear saved progress
            clearProgress();
            
            // Reset state variables
            selectedAnswersQ2 = [];
            currentExperiment = null;
            actionCount = 0;
            currentPage = 'page-1';

            // Reset UI elements
            document.querySelectorAll('.option-btn.selected').forEach(btn => btn.classList.remove('selected'));
            const submitBtn = document.getElementById('q2-submit');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50');
            }

            // Reset experiment page
            const water = document.getElementById('water');
            const fabric = document.getElementById('fabric-in-bucket');
            const shirtInBucket = document.getElementById('shirt-in-bucket');
            const resultShirt = document.getElementById('result-shirt');
            const info = document.getElementById('experiment-info');
            const kucekBtn = document.getElementById('action-kucek');
            const sikatBtn = document.getElementById('action-sikat');
            
            if (water) water.style.height = '0px';
            if (fabric) fabric.style.opacity = '0';
            if (shirtInBucket) {
                shirtInBucket.src = 'baju-kotor.png';
                shirtInBucket.alt = 'Baju dalam ember';
            }
            if (resultShirt) {
                resultShirt.src = 'baju-kotor.png';
                resultShirt.alt = 'Hasil Cucian';
            }
            if (info) info.textContent = '';
            if (kucekBtn) kucekBtn.disabled = true;
            if (sikatBtn) sikatBtn.disabled = true;
            document.querySelectorAll('#page-6 .option-btn').forEach(b => b.classList.remove('selected'));
            
            // Hide retry button
            const retryBtn = document.getElementById('retry-washing-btn');
            if (retryBtn) {
                retryBtn.style.display = 'none';
            }
            
            // Hide ingredients
            const ingredients = document.getElementById('washing-ingredients');
            if (ingredients) {
                ingredients.style.opacity = '0';
            }
            
            // Reset conclusion button
            updateConclusionButton(false);
            
            // Reset page history
            pageHistory = ['page-1'];
            gameProgress.pageHistory = ['page-1'];
            
            // Reset drag and drop
            ingredientsInBucket = [];
            draggedIngredient = null;
            
            // Reset to first page and restart intro sequence
            showPage('page-1');
            const bubbleElement = document.getElementById('bubble-text-1');
            if (bubbleElement) {
                bubbleElement.textContent = '';
            }
            
            // Restart the intro sequence
            setTimeout(() => {
                runIntroSequence();
            }, 500);
        }

    </script>
</body>
</html>

